 {% extends 'configs/base.html' %}
{% block mainContent %}
 <style>
.chart-scroll {
    overflow-x: auto;
    overflow-y: hidden;
    width: 100%;
}
.chart-scroll canvas {
    min-width: 600px;   /* baseline width */
    max-width: none;    /* let it grow */
}
</style>
<div class="content-wrapper">
  <div class="row">
    <div class="col-12">
      <div class="home-tab">

        <!-- Navigation Tabs -->
        <div class="d-flex flex-wrap align-items-center justify-content-between border-bottom pb-2 mb-3">
          <ul class="nav nav-tabs mb-2 mb-md-0" role="tablist">
            <li class="nav-item">
              <a class="nav-link active ps-0" id="home-tab" data-bs-toggle="tab" href="#overview" role="tab">Sales</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="profile-tab" data-bs-toggle="tab" href="#audiences" role="tab">Stocks</a>
            </li>
          </ul>
          <div class="btn-wrapper">
            <a href="#" class="btn btn-outline-dark align-items-center"><i class="icon-share"></i> Share</a>
            <a href="#" class="btn btn-outline-dark"><i class="icon-printer"></i> Print</a>
            <a href="#" class="btn btn-primary text-white"><i class="icon-download"></i> Export</a>
          </div>
        </div>

        <!-- Tab Content -->
        <div class="tab-content tab-content-basic">
          <div class="tab-pane fade show active" id="overview" role="tabpanel">

            <!-- Stats Row -->
            <div class="row">
              <div class="col-12">
                <div class="statistics-details d-flex align-items-center justify-content-between flex-wrap">
                  <div>
                    <p class="statistics-title">Sales Today</p>
                    <h3 class="rate-percentage">{{sales_today}}</h3>
                    {% if growth_today > 0 %}
                      <p class="text-success d-flex"><i class="mdi mdi-menu-up"></i><span>{{growth_today}}</span></p>
                    {% else %}
                      <p class="text-danger d-flex"><i class="mdi mdi-menu-down"></i><span>{{growth_today}}</span></p>
                    {% endif %}
                  </div>
                  <div>
                    <p class="statistics-title">Sales This Week</p>
                    <h3 class="rate-percentage">{{sales_week}}</h3>
                    {% if growth_week > 0 %}
                      <p class="text-success d-flex"><i class="mdi mdi-menu-up"></i><span>{{growth_week}}</span></p>
                    {% else %}
                      <p class="text-danger d-flex"><i class="mdi mdi-menu-down"></i><span>{{growth_week}}</span></p>
                    {% endif %}
                  </div>
                  <div>
                    <p class="statistics-title">Sales This Month</p>
                    <h3 class="rate-percentage">{{sales_month}}</h3>
                    {% if growth_month > 0 %}
                      <p class="text-success d-flex"><i class="mdi mdi-menu-up"></i><span>{{growth_month}}</span></p>
                    {% else %}
                      <p class="text-danger d-flex"><i class="mdi mdi-menu-down"></i><span>{{growth_month}}</span></p>
                    {% endif %}
                  </div>
                  <div class="d-none d-md-block">
                    <p class="statistics-title">Sales This Year</p>
                    <h3 class="rate-percentage">{{sales_year}}</h3>
                    {% if growth_year > 0 %}
                      <p class="text-success d-flex"><i class="mdi mdi-menu-up"></i><span>{{growth_year}}</span></p>
                    {% else %}
                      <p class="text-danger d-flex"><i class="mdi mdi-menu-down"></i><span>{{growth_year}}</span></p>
                    {% endif %}
                  </div>
                  <div class="d-none d-md-block">
                    <p class="statistics-title">Avg. sales/Agent/per day</p>
                    <h3 class="rate-percentage">{{avg_per_agent_today}}</h3>
                    <p class="text-info d-flex"><i class="mdi mdi-menu"></i><span>--</span></p>
                  </div>
                  <div class="d-none d-md-block">
                    <p class="statistics-title">Avg. sales/Agent/per week</p>
                    <h3 class="rate-percentage">{{avg_per_agent_week}}</h3>
                    <p class="text-info d-flex"><i class="mdi mdi-menu"></i><span>--</span></p>
                  </div>
                </div>
              </div>
            </div>

            <div class="row">
              <!-- Sales Overview -->
              <div class="col-lg-8 col-md-12 d-flex flex-column">
                <div class="card card-rounded mb-3">
                  <div class="card-body">
                    <div class="d-flex flex-wrap justify-content-between align-items-start">
                      <h4 class="card-title card-title-dash">Sales Overview</h4>
                      <div>
                        <select id="chart-period" class="form-select form-select-sm"
                          hx-get="{% url 'sales-chart-data' %}"
                          hx-target="#sales-chart"
                          hx-indicator="#chart-spinner"
                          hx-trigger="change"
                          name="period">
                          <option value="day">Daily</option>
                          <option value="week">Weekly</option>
                          <option value="month">Monthly</option>
                        </select>
                        <div id="chart-spinner" class="htmx-indicator text-center my-2">
                          <div class="spinner-border text-primary" role="status"></div>
                        </div>
                      </div>
                    </div>
                    <div class="chartjs-bar-wrapper mt-3">
                      <div class="chart-scroll" style="min-height:300px;">
                        <canvas id="sales-chart"></canvas>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Top Sellers -->
                <div class="card card-rounded mb-3">
                  <div class="card-body">
                    <div class="d-flex flex-wrap justify-content-between align-items-start mb-3">
                      <h4 class="card-title card-title-dash">Top Sellers</h4>
                      <a class="btn btn-success btn-sm text-white" hx-boost="true" href="{% url 'register-users' %}">
                        <i class="mdi mdi-account-plus"></i> Add new member
                      </a>
                    </div>
                    <div class="table-responsive">
                      <table class="table table-sm table-striped align-middle">
                        <thead class="table-light">
                          <tr>
                            <th>#</th>
                            <th>Seller</th>
                            <th>Full Name</th>
                            <th>Qty</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for seller in top_sellers %}
                          <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>
                              {% if seller.sold_by__profile__photo %}
                                <img src="{{ seller.sold_by__profile__photo.url }}" 
                                  alt="{{ seller.sold_by__profile__full_name }}" 
                                  class="rounded-circle me-2" width="40" height="40">
                              {% else %}
                                <img src="https://via.placeholder.com/40" 
                                  alt="No Photo" class="rounded-circle me-2">
                              {% endif %}
                            </td>
                            <td>{{ seller.sold_by__profile__full_name }}</td>
                            <td>{{ seller.total }}</td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Sidebar -->
              <div class="col-lg-4 col-md-12 d-flex flex-column">
                <!-- Monthly Sales by Product -->
                <div class="card card-rounded mb-3">
                  <div class="card-body">
                    <h4 class="card-title card-title-dash">ðŸ“Š Monthly Sales by Product</h4>
                    <div class="table-responsive mt-2">
                      <table class="table table-sm table-striped table-bordered mb-0">
                        <thead class="table-light">
                          <tr>
                            <th>Product</th>
                            <th class="text-end">Total Sold</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for product in monthly_by_product %}
                          <tr>
                            <td>{{ product.stock__product__model_name }}</td>
                            <td class="text-end">{{ product.total }}</td>
                          </tr>
                          {% empty %}
                          <tr>
                            <td colspan="2" class="text-center text-muted">No sales this month</td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>

                <!-- Product Share -->
                <div class="card card-rounded mb-3">
                  <div class="card-body text-center">
                    <h4 class="card-title card-title-dash mb-3">Product Share (%)</h4>
                    <canvas id="sales-model-doughnut"></canvas>
                    <div id="doughnutChart-legend" class="mt-3"></div>
                  </div>
                </div>

                <!-- Product Qty -->
                <div class="card card-rounded">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                      <h4 class="card-title card-title-dash">Product Qty</h4>
                      <div class="dropdown">
                        <button class="btn btn-light btn-sm dropdown-toggle" type="button" id="dropdownMenuButton3" data-bs-toggle="dropdown">
                          Month Wise
                        </button>
                        <div class="dropdown-menu">
                          <a class="dropdown-item" href="#">Week Wise</a>
                          <a class="dropdown-item" href="#">Year Wise</a>
                        </div>
                      </div>
                    </div>
                    <div class="chart-scroll">
                      <canvas id="sales-product-bar"></canvas>
                    </div>
                  </div>
                </div>

              </div>
            </div> <!-- row -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let salesChart;

function renderSalesChart(labels, values) {
    const ctx = document.getElementById('sales-chart').getContext('2d');
    if (salesChart) {
        salesChart.destroy();
    }
    salesChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Sales',
                data: values,
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13,110,253,0.2)',
                tension: 0.3,
                fill: true,
                pointRadius: 4,
                pointBackgroundColor: '#0d6efd'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: true }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

// Initial chart load (daily sales)
fetch("{% url 'sales-chart-data' %}?period=day")
  .then(res => res.json())
  .then(data => renderSalesChart(data.labels, data.values));

// Update chart after HTMX request
document.body.addEventListener("htmx:afterOnLoad", function(evt) {
    if (evt.detail.xhr.response) {
        try {
            const data = JSON.parse(evt.detail.xhr.response);
            renderSalesChart(data.labels, data.values);
        } catch (e) {}
    }
});

let productBarChart, modelDoughnutChart;

function renderProductBarChart(labels, values) {
    const ctx = document.getElementById("sales-product-bar").getContext("2d");
    if (productBarChart) productBarChart.destroy();

    productBarChart = new Chart(ctx, {
        type: "bar",
        data: {
            labels: labels,
            datasets: [{
                label: "Units Sold",
                data: values,
                backgroundColor: "rgba(13,110,253,0.7)",
                borderRadius: 6,
                barThickness: 30,
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(ctx) {
                            return "ðŸ“¦ " + ctx.formattedValue + " units";
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: "Quantity Sold" }
                },
                x: {
                    ticks: { autoSkip: false, maxRotation: 45, minRotation: 30 }
                }
            }
        }
    });
}

function renderModelDoughnutChart(labels, values) {
    const ctx = document.getElementById("sales-model-doughnut").getContext("2d");
    if (modelDoughnutChart) modelDoughnutChart.destroy();

    modelDoughnutChart = new Chart(ctx, {
        type: "doughnut",
        data: {
            labels: labels,
            datasets: [{
                label: "Sales % by Model",
                data: values,
                backgroundColor: [
                    "#0d6efd", "#198754", "#ffc107", "#dc3545", "#6f42c1",
                    "#20c997", "#fd7e14", "#6610f2"
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: "right" },
                tooltip: {
                    callbacks: {
                        label: function(ctx) {
                            let total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                            let percentage = ((ctx.raw / total) * 100).toFixed(1);
                            return ctx.label + ": " + ctx.raw + " (" + percentage + "%)";
                        }
                    }
                }
            }
        }
    });
}

// Initial load (fetch from Django)
fetch("{% url 'sales-per-product-data' %}")
  .then(res => res.json())
  .then(data => renderProductBarChart(data.labels, data.values));

fetch("{% url 'sales-per-model-data' %}")
  .then(res => res.json())
  .then(data => renderModelDoughnutChart(data.labels, data.values));
</script>
{% endblock mainContent %}